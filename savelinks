#!/bin/sh
#usage: path/to/savelinks [chroot dir]/path/to/target/dir
#the script should be executed within the target dir; pwd should be the target dir.
#NOTE: '/' after the target directory name is strictly required, not to irreversibly break all the l2symlink directions.
#chdir to target dir before calling the script, or use autolinks instead.
dest="$(pwd)"
delim="$1"
find $dest -type l | sed 's,^,ls -l ,' | sed 's,$, | cut -d: -f2- | cut -d" " -f2-,' > linker
sh linker > links
cat links | while read line
do
    link="$(echo $line | cut -d' ' -f1 | sed 's,^.*'$delim',,')"
    src="$(echo $line | cut -d' ' -f3 | sed 's,^.*'$delim',,')"
    ln -sfn "$src" "$link"
done
